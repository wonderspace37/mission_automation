def generate_kml(init_lat, init_lon, init_bearing, waypoints):
    from math import sin, cos, atan2, asin, radians, degrees

    R = 6378137.0

    def dest_point(lat, lon, bearing, dist):
        lat1 = radians(lat)
        lon1 = radians(lon)
        brg = radians(bearing)
        dr = dist / R

        lat2 = asin(
            sin(lat1) * cos(dr) +
            cos(lat1) * sin(dr) * cos(brg)
        )
        lon2 = lon1 + atan2(
            sin(brg) * sin(dr) * cos(lat1),
            cos(dr) - sin(lat1) * sin(lat2)
        )
        return degrees(lat2), degrees(lon2)

    # ====== Compute absolute GPS for each waypoint ======
    coords = []
    for wp in waypoints:
        abs_bearing = (init_bearing + wp["bearing"]) % 360
        lat, lon = dest_point(init_lat, init_lon, abs_bearing, wp["horizontal"])
        coords.append((lon, lat, wp["vertical"]))

    # ====== Clean XML generation (no spaces before <?xml) ======
    kml = """<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
    <name>Mission Path</name>
    <Style id="lineStyle">
        <LineStyle>
            <color>ff00ffff</color>
            <width>3</width>
        </LineStyle>
    </Style>
    <Placemark>
        <name>Flight Path</name>
        <styleUrl>#lineStyle</styleUrl>
        <LineString>
            <extrude>true</extrude>
            <tessellate>true</tessellate>
            <altitudeMode>absolute</altitudeMode>
            <coordinates>
"""
    # Append coordinates
    for lon, lat, alt in coords:
        kml += f"{lon},{lat},{alt}\n"

    # Close nodes
    kml += """            </coordinates>
        </LineString>
    </Placemark>
</Document>
</kml>
"""

    # Ensure UTF-8 without BOM
    return kml.encode("utf-8")
