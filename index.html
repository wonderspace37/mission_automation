<script>
  let map, markers = [];
  let home = { lat: 37.526643, lon: -121.966697, alt: 5 };
  
  // ---------- MAP INIT ----------
  map = new maplibregl.Map({
    container: 'map',
    style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
    center: [home.lon, home.lat],
    zoom: 16,
    pitch: 55,
    bearing: -20
  });
  
  map.on('load', () => {
    drawHomeLabel();
    drawHomeMarker();
    document.getElementById('lat').onchange = document.getElementById('lon').onchange = () => {
      home.lat = parseFloat(document.getElementById('lat').value);
      home.lon = parseFloat(document.getElementById('lon').value);
      drawHomeMarker();
      drawHomeLabel();
      updateMarkers();
    };
  
    map.addSource('terrainSource', {
      type: 'raster-dem',
      url: 'https://demotiles.maplibre.org/terrain-tiles/tiles.json',
      tileSize: 512,
      maxzoom: 14
    });
    map.setTerrain({ source: 'terrainSource', exaggeration: 2.0 });
  });
  
  function drawHomeLabel() {
    if (window.homeLabel) homeLabel.remove();
    const el = document.createElement('div');
    el.textContent = 'Home';
    el.style.cssText = `
      color:white;background:#22c55e;border:1px solid #0b0;
      border-radius:6px;padding:2px 6px;font-size:11px;
      position:absolute;transform:translate(-50%,-120%);
      font-weight:600;
    `;
    window.homeLabel = new maplibregl.Marker({ element: el })
      .setLngLat([home.lon, home.lat])
      .addTo(map);
  }
  
  function drawHomeMarker(){
    if (window.homeMarker) homeMarker.remove();
    const el = document.createElement('div');
    el.style.cssText = 'width:16px;height:16px;background:#22c55e;border:2px solid #fff;border-radius:50%';
    window.homeMarker = new maplibregl.Marker({ element: el })
      .setLngLat([home.lon, home.lat])
      .addTo(map);
  }
  
  // ---------- ADD WAYPOINT ----------
  document.getElementById('addWaypoint').onclick = () => {
    const idx = markers.length + 1;
    const tbody = document.querySelector('#wpTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx}</td>
      <td><input data-k="distance" value="10"></td>
      <td><input data-k="altitude" value="5"></td>
      <td><input data-k="heading" value="0"></td>
      <td><input data-k="speed" value="5"></td>
      <td class="actions"><button data-del="${idx-1}">✖</button></td>`;
    tbody.appendChild(tr);
    bindInputs();
    updateMarkers();
  };
  
  function bindInputs(){
    document.querySelectorAll('#wpTable input[data-k]').forEach(inp=>{
      inp.onchange = ()=> updateMarkers();
    });
    document.querySelectorAll('#wpTable button[data-del]').forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.dataset.del);
        if(markers[i]) { markers[i].marker.remove(); if(markers[i].label) markers[i].label.remove(); }
        markers.splice(i,1);
        renderTable();
      };
    });
  }
  
  function destination(lat, lon, bearing, dist){
    const R = 6378137.0;
    const brg = bearing * Math.PI/180;
    const dR = dist / R;
    const lat1 = lat*Math.PI/180, lon1 = lon*Math.PI/180;
    const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dR)+Math.cos(lat1)*Math.sin(dR)*Math.cos(brg));
    const lon2 = lon1 + Math.atan2(Math.sin(brg)*Math.sin(dR)*Math.cos(lat1), Math.cos(dR)-Math.sin(lat1)*Math.sin(lat2));
    return { lat: lat2*180/Math.PI, lon: lon2*180/Math.PI };
  }
  
  // ---------- UPDATE MARKERS ----------
  function updateMarkers(){
    markers.forEach(m=>{ m.marker.remove(); if (m.label) m.label.remove(); });
    markers = [];
  
    const initBearing = parseFloat(document.getElementById('bearing').value || 0);
  
    document.querySelectorAll('#wpTable tbody tr').forEach((tr,i)=>{
      const d = parseFloat(tr.querySelector('input[data-k="distance"]').value || 0);
      const a = parseFloat(tr.querySelector('input[data-k="altitude"]').value || 2);
      const rel = parseFloat(tr.querySelector('input[data-k="heading"]').value || 0);
      const s = parseFloat(tr.querySelector('input[data-k="speed"]').value || 0);
      const absB = (initBearing + rel) % 360;
      const coord = destination(home.lat, home.lon, absB, d);
  
      // WP marker
      const el = document.createElement('div');
      el.style.cssText = 'width:14px;height:14px;background:#3b82f6;border:2px solid #fff;border-radius:50%';
      const m = new maplibregl.Marker({ element: el, draggable: true })
        .setLngLat([coord.lon, coord.lat])
        .addTo(map);
  
      // Label
      const labelEl = document.createElement('div');
      labelEl.textContent = `${i + 1}`;
      labelEl.style.cssText = `
        color:white;background:#0f141c;border:1px solid #444;border-radius:4px;
        padding:1px 4px;font-size:11px;position:absolute;transform:translate(-50%, -120%);
        pointer-events:none;
      `;
      const label = new maplibregl.Marker({ element: labelEl })
        .setLngLat([coord.lon, coord.lat])
        .addTo(map);
  
      const wp = { marker: m, label, distance: d, altitude: a, heading: rel, absBearing: absB, speed: s };
      markers.push(wp);
    });
  }
  
  // ---------- CLEAR ----------
  document.getElementById('clearWPs').onclick = ()=>{
    markers.forEach(w=>{ w.marker.remove(); if (w.label) w.label.remove(); });
    markers=[];
    document.querySelector('#wpTable tbody').innerHTML='';
  };
  
  // ---------- CSV GENERATION ----------
  document.getElementById('generate').onclick = async ()=>{
    const initBearing = parseFloat(document.getElementById('bearing').value || 0);
    const payload = {
      init_lat: parseFloat(document.getElementById('lat').value),
      init_lon: parseFloat(document.getElementById('lon').value),
      init_bearing: initBearing,
      poi_altitude: parseFloat(document.getElementById('poi').value || 1),
      waypoints: markers.map(w=>({
        horizontal: w.distance,
        vertical: w.altitude,
        bearing: w.heading,
        hold_time: 0,
        speed: w.speed
      }))
    };
  
    try {
      document.getElementById('status').textContent = '⏳ Generating CSV...';
      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
  
      if (!res.ok) throw new Error('Server returned ' + res.status);
  
      const blob = await res.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'litchi_waypoints.csv';
      a.click();
      document.getElementById('status').textContent = '✅ CSV ready.';
    } catch (e) {
      document.getElementById('status').textContent = '❌ ' + e.message;
    }
  };
  
  // ---------- KML GENERATION ----------
  document.getElementById('generateKML').onclick = async () => {
    console.log("KML button clicked");
  
    const initBearing = parseFloat(document.getElementById('bearing').value || 0);
    const payload = {
      init_lat: parseFloat(document.getElementById('lat').value),
      init_lon: parseFloat(document.getElementById('lon').value),
      init_bearing: initBearing,
      poi_altitude: parseFloat(document.getElementById('poi').value || 1),
      waypoints: markers.map(w=>({
        horizontal: w.distance,
        vertical: w.altitude,
        bearing: w.heading,
        speed: w.speed
      }))
    };
  
    try {
      document.getElementById('status').textContent = '⏳ Generating KML...';
  
      const res = await fetch('/api/generate_kml', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
  
      if (!res.ok) throw new Error('Server returned ' + res.status);
  
      const blob = await res.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'mission_path.kml';
      a.click();
  
      document.getElementById('status').textContent = '✅ KML ready.';
    } catch (e) {
      document.getElementById('status').textContent = '❌ ' + e.message;
    }
  };
  </script>
  