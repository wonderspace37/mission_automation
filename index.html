<div class="hr"></div>
<table id="wpTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Distance (m)</th>
      <th>Altitude (m)</th>
      <th>Heading (¬∞ rel)</th>
      <th>Speed (m/s)</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div class="hr"></div>

<div class="stack">
  <button class="ghost" id="preview3s">üé¨ 3-sec Preview</button>
  <button class="primary" id="generate">Generate CSV</button>
</div>
<div id="status" class="hint"></div>

<!-- ======================== SCRIPT ======================== -->
<script>
let map, markers = [];
let home = { lat: 37.526643, lon: -121.966697, alt: 5 };

// ---------------- MAP INIT ----------------
map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
  center: [home.lon, home.lat],
  zoom: 16
});
map.addControl(new maplibregl.NavigationControl(), 'top-right');

map.on('load', () => {
  drawHomeMarker();
});

// ---------------- DRAW HOME ----------------
function drawHomeMarker(){
  if (!map) return;
  const el = document.createElement('div');
  el.style.cssText = 'width:16px;height:16px;background:#22c55e;border:2px solid #fff;border-radius:50%';
  new maplibregl.Marker({ element: el })
    .setLngLat([home.lon, home.lat])
    .addTo(map);
}

// ---------------- ADD WAYPOINT ----------------
document.getElementById('addWaypoint').onclick = () => {
  const idx = markers.length + 1;
  const tbody = document.querySelector('#wpTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${idx}</td>
    <td><input data-k="distance" data-idx="${idx-1}" value="10"></td>
    <td><input data-k="altitude" data-idx="${idx-1}" value="5"></td>
    <td><input data-k="heading" data-idx="${idx-1}" value="0"></td>
    <td><input data-k="speed" data-idx="${idx-1}" value="5"></td>
    <td class="actions"><button data-del="${idx-1}">‚úñ</button></td>`;
  tbody.appendChild(tr);
  bindInputs();
  updateMarkers();
};

// ---------------- BIND INPUTS ----------------
function bindInputs(){
  document.querySelectorAll('#wpTable input[data-k]').forEach(inp=>{
    inp.onchange = ()=> updateMarkers();
  });
  document.querySelectorAll('#wpTable button[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const i = Number(btn.dataset.del);
      if(markers[i]) markers[i].marker.remove();
      markers.splice(i,1);
      renderTable();
    };
  });
}

// ---------------- GEO UTILS ----------------
function destination(lat, lon, bearing, dist){
  const R = 6378137.0;
  const brg = bearing * Math.PI/180;
  const dR = dist / R;
  const lat1 = lat*Math.PI/180, lon1 = lon*Math.PI/180;
  const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dR)+Math.cos(lat1)*Math.sin(dR)*Math.cos(brg));
  const lon2 = lon1 + Math.atan2(Math.sin(brg)*Math.sin(dR)*Math.cos(lat1), Math.cos(dR)-Math.sin(lat1)*Math.sin(lat2));
  return { lat: lat2*180/Math.PI, lon: lon2*180/Math.PI };
}

// ---------------- UPDATE MARKERS ----------------
function updateMarkers(){
  if (!map) return;
  markers.forEach(m=>m.marker.remove());
  markers = [];
  const initBearing = parseFloat(document.getElementById('bearing').value || 0);

  document.querySelectorAll('#wpTable tbody tr').forEach((tr,i)=>{
    const d = parseFloat(tr.querySelector('input[data-k="distance"]').value || 0);
    const a = parseFloat(tr.querySelector('input[data-k="altitude"]').value || 2);
    const rel = parseFloat(tr.querySelector('input[data-k="heading"]').value || 0);
    const s = parseFloat(tr.querySelector('input[data-k="speed"]').value || 0);
    const absB = (initBearing + rel) % 360;
    const coord = destination(home.lat, home.lon, absB, d);

    const el = document.createElement('div');
    el.style.cssText = 'width:14px;height:14px;background:#3b82f6;border:2px solid #fff;border-radius:50%';
    const m = new maplibregl.Marker({element:el,draggable:true})
      .setLngLat([coord.lon,coord.lat])
      .addTo(map);

    const wp = {marker:m, distance:d, altitude:a, heading:rel, absBearing:absB, speed:s};

    m.on('dragend',()=>{
      const p = m.getLngLat();
      const newD = turf.distance(turf.point([home.lon,home.lat]), turf.point([p.lng,p.lat]), {units:'kilometers'})*1000;
      const tB = turf.bearing(turf.point([home.lon,home.lat]), turf.point([p.lng,p.lat]));
      let relNew = (tB - initBearing)%360; if(relNew<0) relNew+=360;
      tr.querySelector('input[data-k="distance"]').value = newD.toFixed(1);
      tr.querySelector('input[data-k="heading"]').value = relNew.toFixed(1);
      wp.distance = newD; wp.heading = relNew;
    });

    markers.push(wp);
  });
}

// ---------------- RENDER TABLE ----------------
function renderTable(){
  const old = document.querySelector('#wpTable tbody');
  const newBody = document.createElement('tbody');
  markers.forEach((wp,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input data-k="distance" data-idx="${i}" value="${wp.distance.toFixed(1)}"></td>
      <td><input data-k="altitude" data-idx="${i}" value="${wp.altitude.toFixed(1)}"></td>
      <td><input data-k="heading" data-idx="${i}" value="${wp.heading.toFixed(1)}"></td>
      <td><input data-k="speed" data-idx="${i}" value="${wp.speed.toFixed(1)}"></td>
      <td class="actions"><button data-del="${i}">‚úñ</button></td>`;
    newBody.appendChild(tr);
  });
  old.parentNode.replaceChild(newBody, old);
  bindInputs();
  updateMarkers();
}

// ---------------- CLEAR ----------------
document.getElementById('clearWPs').onclick = ()=>{
  markers.forEach(w=>w.marker.remove());
  markers=[];
  document.querySelector('#wpTable tbody').innerHTML='';
};

// ---------------- CSV GENERATION ----------------
document.getElementById('generate').onclick = async ()=>{
  const initBearing = parseFloat(document.getElementById('bearing').value || 0);
  const payload = {
    init_lat: parseFloat(document.getElementById('lat').value),
    init_lon: parseFloat(document.getElementById('lon').value),
    init_bearing: initBearing,
    poi_altitude: parseFloat(document.getElementById('poi').value || 1),
    waypoints: markers.map(w=>({
      horizontal: w.distance,
      vertical: w.altitude,
      bearing: w.heading,
      hold_time: 0,
      speed: w.speed
    }))
  };

  try {
    document.getElementById('status').textContent = '‚è≥ Generating...';
    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error('Server returned ' + res.status);
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'litchi_waypoints.csv';
    a.click();
    document.getElementById('status').textContent = '‚úÖ CSV ready.';
  } catch (e) {
    console.error(e);
    document.getElementById('status').textContent = '‚ùå ' + e.message;
  }
};
</script>
