<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Automation ‚Ä¢ Relative Waypoints</title>

  <!-- MapLibre, Turf, Three.js -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <style>
    :root {
      --bg: #0e1117;
      --panel: #151a23;
      --muted: #8a8fa3;
      --text: #e7e9ef;
      --accent: #3b82f6;
      --border: #21293a;
    }
    * { box-sizing: border-box }
    html,body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .layout {
      display: grid;
      grid-template-columns: 360px 1fr;
      grid-template-rows: 55% 45%;
      gap: 10px;
      height: 100vh;
      padding: 10px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.25);
      padding: 14px;
      overflow: auto;
    }
    #map { width: 100%; height: 100%; border-radius: 14px }
    #preview3d { width: 100%; height: 100%; border-radius: 14px; background: #0b0d12 }
    h1 { font-size: 18px; margin: 0 0 10px }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px }
    input,button {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f141c;
      color: var(--text);
    }
    input:focus { outline: 2px solid #24406d }
    button.primary {
      background: var(--accent);
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button.ghost {
      background: #101521;
      border: 1px solid var(--border);
      cursor: pointer;
    }
    .stack { display: flex; gap: 10px }
    .stack>* { flex: 1 }
    .hr { height: 1px; background: var(--border); margin: 12px 0 }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px }
    th,td { border-bottom: 1px solid var(--border); padding: 6px 4px; text-align: left }
    th { color: #aab }
    td.actions { width: 40px; text-align: right }
    .hint { font-size: 12px; color: #9aa4bd; margin-top: 6px }
  </style>
</head>
<body>
  <div class="layout">
    <div class="panel">
      <h1>üõ∞Ô∏è Mission Automation ‚Äî Relative Waypoints</h1>

      <div class="row">
        <div>
          <label>Initial Latitude</label>
          <input id="lat" value="37.526643">
        </div>
        <div>
          <label>Initial Longitude</label>
          <input id="lon" value="-121.966697">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Initial Bearing (¬∞ from North)</label>
          <input id="bearing" value="60">
        </div>
        <div>
          <label>POI Altitude (m)</label>
          <input id="poi" value="1">
        </div>
      </div>

      <div class="hr"></div>
      <div class="stack">
        <button class="primary" id="addWaypoint">‚ûï Add Waypoint</button>
        <button class="ghost" id="clearWPs">üóëÔ∏è Clear</button>
      </div>

      <div class="hr"></div>
      <table id="wpTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Distance (m)</th>
            <th>Altitude (m)</th>
            <th>Heading (¬∞ rel)</th>
            <th>Speed (m/s)</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="hr"></div>
      <div class="stack">
        <button class="ghost" id="preview3s">üé¨ 3-sec Preview</button>
        <button class="primary" id="generate">Generate CSV</button>
      </div>
      <div id="status" class="hint"></div>
    </div>

    <div id="map" class="panel"></div>
    <div id="preview3d" class="panel"></div>
  </div>

<script>
let map, markers = [];
let home = { lat: 37.526643, lon: -121.966697, alt: 5 };

// ---------- MAP INIT ----------
map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
  center: [home.lon, home.lat],
  zoom: 16
});
map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.on('load', () => drawHomeMarker());

function drawHomeMarker(){
  const el = document.createElement('div');
  el.style.cssText = 'width:16px;height:16px;background:#22c55e;border:2px solid #fff;border-radius:50%';
  new maplibregl.Marker({ element: el }).setLngLat([home.lon, home.lat]).addTo(map);
}

// ---------- ADD WAYPOINT ----------
document.getElementById('addWaypoint').onclick = () => {
  const idx = markers.length + 1;
  const tbody = document.querySelector('#wpTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${idx}</td>
    <td><input data-k="distance" value="10"></td>
    <td><input data-k="altitude" value="5"></td>
    <td><input data-k="heading" value="0"></td>
    <td><input data-k="speed" value="5"></td>
    <td class="actions"><button data-del="${idx-1}">‚úñ</button></td>`;
  tbody.appendChild(tr);
  bindInputs();
  updateMarkers();
};

function bindInputs(){
  document.querySelectorAll('#wpTable input[data-k]').forEach(inp=>{
    inp.onchange = ()=> updateMarkers();
  });
  document.querySelectorAll('#wpTable button[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const i = Number(btn.dataset.del);
      if(markers[i]) { markers[i].marker.remove(); if(markers[i].label) markers[i].label.remove(); }
      markers.splice(i,1);
      renderTable();
    };
  });
}

function destination(lat, lon, bearing, dist){
  const R = 6378137.0;
  const brg = bearing * Math.PI/180;
  const dR = dist / R;
  const lat1 = lat*Math.PI/180, lon1 = lon*Math.PI/180;
  const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dR)+Math.cos(lat1)*Math.sin(dR)*Math.cos(brg));
  const lon2 = lon1 + Math.atan2(Math.sin(brg)*Math.sin(dR)*Math.cos(lat1), Math.cos(dR)-Math.sin(lat1)*Math.sin(lat2));
  return { lat: lat2*180/Math.PI, lon: lon2*180/Math.PI };
}

// ---------- UPDATE MARKERS ----------
function updateMarkers(){
  if (!map) return;
  markers.forEach(m=>{ m.marker.remove(); if (m.label) m.label.remove(); });
  markers = [];

  const initBearing = parseFloat(document.getElementById('bearing').value || 0);

  document.querySelectorAll('#wpTable tbody tr').forEach((tr,i)=>{
    const d = parseFloat(tr.querySelector('input[data-k="distance"]').value || 0);
    const a = parseFloat(tr.querySelector('input[data-k="altitude"]').value || 2);
    const rel = parseFloat(tr.querySelector('input[data-k="heading"]').value || 0);
    const s = parseFloat(tr.querySelector('input[data-k="speed"]').value || 0);
    const absB = (initBearing + rel) % 360;
    const coord = destination(home.lat, home.lon, absB, d);

    // Create waypoint marker
    const el = document.createElement('div');
    el.style.cssText = 'width:14px;height:14px;background:#3b82f6;border:2px solid #fff;border-radius:50%';
    const m = new maplibregl.Marker({ element: el, draggable: true })
      .setLngLat([coord.lon, coord.lat])
      .addTo(map);

    // Create label (WP#)
    const labelEl = document.createElement('div');
    labelEl.textContent = `WP${i + 1}`;
    labelEl.style.cssText = `
      color:white;background:#0f141c;border:1px solid #444;border-radius:4px;
      padding:1px 4px;font-size:11px;position:absolute;transform:translate(-50%, -120%);
      pointer-events:none;
    `;
    const label = new maplibregl.Marker({ element: labelEl })
      .setLngLat([coord.lon, coord.lat])
      .addTo(map);

    // Update label dynamically while dragging
    m.on('drag', () => {
      const p = m.getLngLat();
      label.setLngLat(p);
    });

    // Update table + internal state after drag end
    m.on('dragend', () => {
      const p = m.getLngLat();
      const newD = turf.distance(turf.point([home.lon,home.lat]), turf.point([p.lng,p.lat]), {units:'kilometers'})*1000;
      const tB = turf.bearing(turf.point([home.lon,home.lat]), turf.point([p.lng,p.lat]));
      let relNew = (tB - initBearing) % 360; 
      if (relNew < 0) relNew += 360;

      tr.querySelector('input[data-k="distance"]').value = newD.toFixed(1);
      tr.querySelector('input[data-k="heading"]').value = relNew.toFixed(1);
      wp.distance = newD;
      wp.heading = relNew;
      label.setLngLat(p);
    });

    const wp = { marker: m, label, distance: d, altitude: a, heading: rel, absBearing: absB, speed: s };
    markers.push(wp);
  });
}


// ---------- CLEAR ----------
document.getElementById('clearWPs').onclick = ()=>{
  markers.forEach(w=>{ w.marker.remove(); if (w.label) w.label.remove(); });
  markers=[];
  document.querySelector('#wpTable tbody').innerHTML='';
};

// ---------- 3D PREVIEW ----------
let scene, camera, renderer, animationId;
const ALT_SCALE = 1;

initThree();

function initThree() {
  const container = document.getElementById('preview3d');
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.innerHTML = '';
  container.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0d12);

  camera = new THREE.PerspectiveCamera(55, container.clientWidth / container.clientHeight, 0.1, 2000);
  camera.position.set(0, -300, 200);

  const sun = new THREE.DirectionalLight(0xffffff, 1.0);
  sun.position.set(200, -150, 300);
  sun.castShadow = true;
  sun.shadow.mapSize.width = 2048;
  sun.shadow.mapSize.height = 2048;
  scene.add(sun);
  scene.add(new THREE.AmbientLight(0x404040, 1.2));

  const grid = new THREE.GridHelper(800, 80, 0x3b82f6, 0x444);
  grid.material.opacity = 0.25;
  grid.material.transparent = true;
  scene.add(grid);

  window.addEventListener('resize', () => {
    const w = container.clientWidth, h = container.clientHeight;
    renderer.setSize(w, h);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.render(scene, camera);
  });
}

function buildPreviewGeometry() {
  for (let i = scene.children.length - 1; i >= 0; i--) {
    const obj = scene.children[i];
    if (obj.userData && (obj.userData.path || obj.userData.wpSphere)) scene.remove(obj);
  }

  const initBearing = parseFloat(document.getElementById('bearing').value || 0);
  const pts = [{ lat: home.lat, lon: home.lon, alt: 5 }];

  document.querySelectorAll('#wpTable tbody tr').forEach(tr => {
    const d   = parseFloat(tr.querySelector('input[data-k="distance"]').value || 0);
    const rel = parseFloat(tr.querySelector('input[data-k="heading"]').value  || 0);
    const alt = parseFloat(tr.querySelector('input[data-k="altitude"]').value || 2);
    const absB = (initBearing + rel) % 360;
    const dest = destination(home.lat, home.lon, absB, d);
    pts.push({ lat: dest.lat, lon: dest.lon, alt });
  });

  if (pts.length < 2) return null;

  const ref = pts[0];
  const toXY = (p) => {
    const e = turf.distance(turf.point([ref.lon, ref.lat]), turf.point([p.lon, ref.lat]), { units: 'kilometers' }) * 1000;
    const n = turf.distance(turf.point([ref.lon, ref.lat]), turf.point([ref.lon, p.lat]), { units: 'kilometers' }) * 1000;
    return [(p.lon >= ref.lon ? e : -e), (p.lat >= ref.lat ? n : -n)];
  };

  const positions = [];
  pts.forEach(p => {
    const [x, y] = toXY(p);
    positions.push(x, y, p.alt * ALT_SCALE);
  });

  const geom = new THREE.BufferGeometry();
  geom.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
  const line = new THREE.Line(geom, new THREE.LineBasicMaterial({ color: 0x3b82f6 }));
  line.userData.path = true;
  scene.add(line);

  pts.forEach((p, i) => {
    const [x, y] = toXY(p);
    const sphere = new THREE.Mesh(
      new THREE.SphereGeometry(3, 24, 18),
      new THREE.MeshStandardMaterial({ color: i === 0 ? 0x22c55e : 0xffffff, roughness: 0.6, metalness: 0.3 })
    );
    sphere.position.set(x, y, p.alt * ALT_SCALE);
    sphere.castShadow = true;
    sphere.receiveShadow = true;
    sphere.userData.wpSphere = true;
    scene.add(sphere);
  });

  renderer.render(scene, camera);
  return { positions: new Float32Array(positions) };
}

document.getElementById('preview3s').onclick = () => {
  const built = buildPreviewGeometry();
  if (!built) return;

  const { positions } = built;
  const drone = new THREE.Mesh(new THREE.SphereGeometry(3, 24, 18), new THREE.MeshStandardMaterial({ color: 0x9ecbff }));
  drone.userData.wpSphere = true;
  scene.add(drone);

  const total = positions.length / 3;
  const duration = 3000;
  const start = performance.now();

  if (animationId) cancelAnimationFrame(animationId);
  const step = (now) => {
    const t = Math.min(1, (now - start) / duration);
    const idxF = t * (total - 1);
    const i = Math.floor(idxF);
    const a = idxF - i;

    const i3 = i * 3;
    const nx = positions[i3]     * (1 - a) + positions[i3 + 3] * a;
    const ny = positions[i3 + 1] * (1 - a) + positions[i3 + 4] * a;
    const nz = positions[i3 + 2] * (1 - a) + positions[i3 + 5] * a;

    drone.position.set(nx, ny, nz);
    camera.lookAt(drone.position);
    renderer.render(scene, camera);

    if (t < 1) animationId = requestAnimationFrame(step);
  };
  animationId = requestAnimationFrame(step);
};

// ---------- CSV GENERATION ----------
document.getElementById('generate').onclick = async ()=>{
  const initBearing = parseFloat(document.getElementById('bearing').value || 0);
  const payload = {
    init_lat: parseFloat(document.getElementById('lat').value),
    init_lon: parseFloat(document.getElementById('lon').value),
    init_bearing: initBearing,
    poi_altitude: parseFloat(document.getElementById('poi').value || 1),
    waypoints: markers.map(w=>({
      horizontal: w.distance,
      vertical: w.altitude,
      bearing: w.heading,
      hold_time: 0,
      speed: w.speed
    }))
  };

  try {
    document.getElementById('status').textContent = '‚è≥ Generating...';
    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error('Server returned ' + res.status);
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'litchi_waypoints.csv';
    a.click();
    document.getElementById('status').textContent = '‚úÖ CSV ready.';
  } catch (e) {
    document.getElementById('status').textContent = '‚ùå ' + e.message;
  }
};
</script>
</body>
</html>
